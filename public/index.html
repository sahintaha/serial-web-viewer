<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Arduino Serial Viewer</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      height: 100vh;
    }

    #left-panel, #right-panel {
      padding: 20px;
      overflow-y: auto;
    }

    #right-panel {
      flex: 2;
      border-left: 1px solid #ccc;
      background: #fff;
    }

    #left-panel {
      flex: 1;
      background: #f9f9f9;
    }

    h2, h3 {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    #data-container, #tagged-data {
      border: 1px solid #ccc;
      height: 180px;
      padding: 10px;
      background: #fdfdfd;
      font-family: monospace;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    select, input, button {
      width: 100%;
      padding: 8px;
      margin: 5px 0 10px;
      font-size: 14px;
    }

    #label-configs div {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }

    #label-configs input {
      flex: 1;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    .port-selector {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin-bottom: 10px;
}

.port-selector select,
.port-selector input {
  width: 100%;
  padding: 8px;
  font-size: 14px;
}

.port-selector input {
  display: none;
}

.custom-toggle {
  font-size: 13px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 10px;
}

.port-wrapper {
  margin-bottom: 15px;
}

.port-label {
  font-weight: 600;
  margin-bottom: 5px;
  display: block;
}

.port-inputs {
  display: flex;
  flex-direction: column;
}

.port-select,
.port-input {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  margin-bottom: 5px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.port-input {
  display: none;
  transition: all 0.3s ease;
}

.toggle-label {
  font-size: 13px;
  color: #444;
  display: flex;
  align-items: center;
  gap: 5px;
}


  </style>
</head>
<body>
  <div id="left-panel">
    <h3>🔧 Seri Port Seçimi</h3>
<!-- Alıcı Port -->
<div class="port-wrapper">
  <label class="port-label">🔌 Alıcı Port:</label>
  <div class="port-inputs">
    <select id="receiver-select" class="port-select"></select>
    <input type="text" id="receiver-custom" class="port-input" placeholder="/dev/ttyUSB0">
  </div>
  <label class="toggle-label">
    <input type="checkbox" id="receiver-custom-toggle"> Elle girmek istiyorum
  </label>
</div>

<!-- Verici Port -->
<div class="port-wrapper">
  <label class="port-label">📤 Verici Port:</label>
  <div class="port-inputs">
    <select id="transmitter-select" class="port-select"></select>
    <input type="text" id="transmitter-custom" class="port-input" placeholder="/dev/ttyUSB1">
  </div>
  <label class="toggle-label">
    <input type="checkbox" id="transmitter-custom-toggle"> Elle girmek istiyorum
  </label>
</div>


    <button onclick="connectPorts()">🔌 Bağlan</button>
    <button onclick="disconnectPorts()">❌ Bağlantıyı Kes</button>

    <h3>🔖 Etiket Ayarları</h3>
    <div id="label-configs">
      <div><input class="prefix" placeholder="Harf"><input class="label" placeholder="Etiket"></div>
      <div><input class="prefix" placeholder="Harf"><input class="label" placeholder="Etiket"></div>
      <div><input class="prefix" placeholder="Harf"><input class="label" placeholder="Etiket"></div>
    </div>

    <h3>📤 Manuel Veri Gönder</h3>
    <input type="text" id="send-input" placeholder="Veri gir...">
    <button onclick="sendData()">📨 Gönder</button>

    <h3>⚙️ Otomatik Gönder</h3>
    <label><input type="checkbox" id="auto-send-checkbox"> Etiketlenmiş veriyi otomatik gönder</label>
    <label>Aralık (ms):</label>
    <input type="number" id="send-interval" value="1000" min="100">
  </div>

  <div id="right-panel">
    <h2>📡 Gelen Veri</h2>
    <div id="data-container"></div>

    <h2>📋 Etiketlenmiş Veri</h2>
    <div id="tagged-data"></div>
  </div>


  <script>
    const socket = io();
    let lastTaggedData = '';
    let autoSendInterval = null;

    const receiverSelect = document.getElementById('receiver-select');
    const transmitterSelect = document.getElementById('transmitter-select');
    const dataContainer = document.getElementById('data-container');
    const taggedDataContainer = document.getElementById('tagged-data');

    fetch('/ports')
      .then(res => res.json())
      .then(ports => {
        receiverSelect.innerHTML = '';
        transmitterSelect.innerHTML = '';
        ports.forEach(port => {
          const option1 = document.createElement('option');
          const option2 = document.createElement('option');
          option1.value = option2.value = port.path;
          option1.textContent = option2.textContent = `${port.path} (${port.manufacturer})`;
          receiverSelect.appendChild(option1);
          transmitterSelect.appendChild(option2);
        });
      });

    function connectPorts() {
      socket.emit('select-ports', {
        receiverPath: receiverSelect.value,
        transmitterPath: transmitterSelect.value
      });
    }

    function disconnectPorts() {
      socket.emit('disconnect-ports');
      clearInterval(autoSendInterval);
    }

    function sendData() {
      const input = document.getElementById('send-input').value.trim();
      if (input) socket.emit('send-data', input);
    }

    document.getElementById('auto-send-checkbox').addEventListener('change', (e) => {
      if (e.target.checked) {
        const intervalMs = parseInt(document.getElementById('send-interval').value) || 1000;
        autoSendInterval = setInterval(() => {
          if (lastTaggedData) socket.emit('send-data', lastTaggedData);
        }, intervalMs);
      } else {
        clearInterval(autoSendInterval);
      }
    });

    socket.on('serial-data', (data) => {
      const div = document.createElement('div');
      div.textContent = data;
      dataContainer.appendChild(div);
      dataContainer.scrollTop = dataContainer.scrollHeight;

      const parts = data.split(',').map(p => p.trim());

      const configs = Array.from(document.querySelectorAll('#label-configs div')).map(div => {
        const prefix = div.querySelector('.prefix').value.trim();
        const label = div.querySelector('.label').value.trim();
        return { prefix, label };
      }).filter(cfg => cfg.prefix && cfg.label);

      const tagged = configs.map(cfg => {
        const match = parts.find(p => p.startsWith(cfg.prefix));
        const value = match ? match.slice(cfg.prefix.length) : '---';
        return `${cfg.label}:${value}`;
      }).join(', ');

      taggedDataContainer.innerHTML = tagged
        .split(', ')
        .map(line => `<div>${line}</div>`).join('');

      lastTaggedData = tagged;
    });


    // Elle giriş checkbox kontrolü
document.getElementById('receiver-custom-toggle').addEventListener('change', (e) => {
  const useCustom = e.target.checked;
  document.getElementById('receiver-select').style.display = useCustom ? 'none' : 'block';
  document.getElementById('receiver-custom').style.display = useCustom ? 'block' : 'none';
});

document.getElementById('transmitter-custom-toggle').addEventListener('change', (e) => {
  const useCustom = e.target.checked;
  document.getElementById('transmitter-select').style.display = useCustom ? 'none' : 'block';
  document.getElementById('transmitter-custom').style.display = useCustom ? 'block' : 'none';
});

// Bağlan fonksiyonunu güncelle
function connectPorts() {
  const receiverUseCustom = document.getElementById('receiver-custom-toggle').checked;
  const transmitterUseCustom = document.getElementById('transmitter-custom-toggle').checked;

  const receiverValue = receiverUseCustom
    ? document.getElementById('receiver-custom').value
    : document.getElementById('receiver-select').value;

  const transmitterValue = transmitterUseCustom
    ? document.getElementById('transmitter-custom').value
    : document.getElementById('transmitter-select').value;

  socket.emit('select-ports', {
    receiverPath: receiverValue,
    transmitterPath: transmitterValue
  });
}


document.getElementById('receiver-custom-toggle').addEventListener('change', (e) => {
  const customInput = document.getElementById('receiver-custom');
  const selectInput = document.getElementById('receiver-select');
  if (e.target.checked) {
    selectInput.style.display = 'none';
    customInput.style.display = 'block';
  } else {
    selectInput.style.display = 'block';
    customInput.style.display = 'none';
  }
});

document.getElementById('transmitter-custom-toggle').addEventListener('change', (e) => {
  const customInput = document.getElementById('transmitter-custom');
  const selectInput = document.getElementById('transmitter-select');
  if (e.target.checked) {
    selectInput.style.display = 'none';
    customInput.style.display = 'block';
  } else {
    selectInput.style.display = 'block';
    customInput.style.display = 'none';
  }
});

function setupPortToggle(toggleId, selectId, inputId) {
  const toggle = document.getElementById(toggleId);
  const select = document.getElementById(selectId);
  const input = document.getElementById(inputId);

  toggle.addEventListener("change", () => {
    if (toggle.checked) {
      select.style.display = "none";
      input.style.display = "block";
    } else {
      select.style.display = "block";
      input.style.display = "none";
    }
  });
}

setupPortToggle('receiver-custom-toggle', 'receiver-select', 'receiver-custom');
setupPortToggle('transmitter-custom-toggle', 'transmitter-select', 'transmitter-custom');



  </script>
</body>
</html>